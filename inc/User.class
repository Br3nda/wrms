<?php
/////////////////////////////////////////////////////////////
//   C L A S S   F O R   U S E R
/////////////////////////////////////////////////////////////
require_once("organisation-selectors-sql.php");

class User {
  var $user_no;
  var $new_record;

  function User( $id ) {
    global $session;

    $this->user_no = 0;
    $this->new_record = true;

    $id = intval("$id");
    if ( $id > 0 ) {
      // Try and load it from file
      $this->ReadUser($id);
    }
    if ( $this->user_no == 0 ) {
      $session->Dbg("User", "Initialising new user values");
      $GLOBALS['edit'] = 1;
      $this->new_record = true;

      // Initialise to standard default values
      $this->base_rate = $session->work_rate;
      $this->box_rows  = "10";
      $this->box_cols  = "60";

      if ( isset($GLOBALS['org_code']) && !($session->AllowedTo('Admin') || $session->AllowedTo('Support'))) {
        $this->org_code = intval($GLOBALS['org_code']);
      }

      // Assign some template-based defaults
      if ( isset($_GET['user_template']) ) {
        // templates aren't done yet :-(
      }
    }
  }


  /////////////////////////////////////////////////////////////
  // ReadUser - Can the user do that?
  /////////////////////////////////////////////////////////////
  function ReadUser ( $id ) {
    global $session;

    // Try and load it from file
    $sql = "SELECT usr.*, organisation.org_name ";
    $sql .= " FROM usr  NATURAL JOIN organisation ";
    $sql .= " WHERE usr.user_no = '$id'";
    if ( !($session->AllowedTo('Admin') || $session->AllowedTo('Support')
            || $session->AllowedTo('Manage') || $session->AllowedTo('OrgMgr')) )
      $sql .= " AND usr.user_no = '$session->user_no' ";
    else if ( ($session->AllowedTo('Manage') || $session->AllowedTo('OrgMgr'))
              && !($session->AllowedTo('Admin') || $session->AllowedTo('Support')) )
      $sql .= " AND usr.org_code = '$session->org_code' ";

    if ( $qry = new PgQuery($sql) ) {
      if ( $qry->Exec("newUser")
              && $qry->rows == 1 && $row = $qry->Fetch() ) {
        $this->new_record = false;
        while( list($k,$v) = each($row) ) {
          $session->Dbg("User", "\$this->{'%-25.25s = %s", "$k'}", $v);
          $this->{$k} = $v;
        }
        $this->GetRoles();

        // Load the settings data
        $this->settings = new Setting( $this->config_data );
        if ( is_object( $this->settings ) ) {
          $this->base_font_size = $this->settings->get('fontsize');
          $this->box_rows  = $this->settings->get('bigboxrows');
          $this->box_cols  = $this->settings->get('bigboxcols');
        }
        if ( "$this->base_font_size" == "" ) $this->base_font_size = "11";
        if ( "$this->box_rows"  == "" ) $this->box_rows  = "10";
        if ( "$this->box_cols"  == "" ) $this->box_cols  = "60";

      }
      else {
        $this->user_no = 0;
        unset( $GLOBALS['user_no'] );
      }
    }
  }


  /////////////////////////////////////////////////////////////
  // AllowedTo - Can the user do that?
  /////////////////////////////////////////////////////////////
  function AllowedTo ( $whatever )
  {
    global $session;

    // fixme: We need to change this to abstract the logic in here of
    // whether the current user can create, update, view things.
    switch( $whatever ) {
      case 'ChangePassword':
      case 'update':
        if ( ($session->AllowedTo("Admin") || $session->AllowedTo("Support") || $session->AllowedTo("OrgMgr") ) )
          return true;
        if ( $this->user_no > 0 && $session->user_no == $this->user_no )
          return true;
        break;

      case 'create':
        if ( ($session->AllowedTo("Admin") || $session->AllowedTo("Support") || $session->AllowedTo("OrgMgr") ) )
          return true;
        break;

      default:
        $session->Dbg("User","AllowedTo: '%s' - %d >>%s<<", $whatever, isset($this->roles[$whatever]), $this->roles[$whatever] );
        return ( isset($this->roles[$whatever]) && $this->roles[$whatever] );
    }
    // By default, they ain't allowed...
    return false;
  }


  /////////////////////////////////////////////////////////////
  // GetRoles - Get the group memberships
  /////////////////////////////////////////////////////////////
  function GetRoles () {
    $this->roles = array();
    $qry = new PgQuery( 'SELECT group_name AS role_name FROM group_member m join ugroup g ON g.group_no = m.group_no WHERE user_no = ? ', $this->user_no );
    if ( $qry->Exec('Login') && $qry->rows > 0 ) {
      while( $role = $qry->Fetch() ) {
        $this->roles[$role->role_name] = true;
      }
    }
  }


  /////////////////////////////////////////////////////////////
  // Render - Return HTML to show the W/R
  //   A separate function is called for each logical area
  //   on the W/R.
  /////////////////////////////////////////////////////////////
  function Render( ) {
    global $session;
    $html = "";

    $ef = new EntryForm( $REQUEST_URI, $this, $GLOBALS['edit'] );
    $ef->NoHelp();  // Prefer this style, for the moment

    if ( $ef->editmode ) {
      $html .= $ef->StartForm( array("autocomplete" => "off" ) );
      if ( $this->user_no > 0 ) $html .= $ef->HiddenField( "user_no", $this->user_no );
    }

    $html .= "<table width=\"100%\" class=\"data\" cellspacing=\"0\" cellpadding=\"0\">\n";

    $html .= $this->RenderDetails($ef);

    if ( $session->AllowedTo("Admin") || $session->AllowedTo("Support")
            || $session->AllowedTo("OrgMgr") || $session->AllowedTo("Manage") ) {
      $html .= $this->RenderAccessRoles($ef);
    }
    $html .= $this->RenderFontChoices($ef);
    $html .= $this->RenderSystemRoles($ef);

    $html .= "</table>\n";
    if ( $ef->editmode ) {
      $html .= '<div id="footer">';
      $html .= $ef->SubmitButton( "submit", ($this->new_record ? "Create" : "Update") );
      $html .= '</div>';
      $html .= $ef->EndForm();
    }

    return $html;
  }


  function RenderDetails( $ef ) {
    global $session;
    $html = "";
    $html .= $ef->BreakLine("User Details");

    $html .= $ef->DataEntryLine( "User Name", $this->username, "text", "username",
              array( "size" => 20, "title" => "The name this user can log into the system with."), 'xxxx' );
    if ( $ef->editmode && $this->AllowedTo('ChangePassword') ) {
      $this->new_password = '******';
      unset($_POST['new_password']);
      $html .= $ef->DataEntryLine( "New Password", "%s", "password", "new_password",
                array( "size" => 20, "title" => "The user's password for logging in.") );
      $this->confirm_password = '******';
      unset($_POST['confirm_password']);
      $html .= $ef->DataEntryLine( "Confirm", "%s", "password", "confirm_password",
                array( "size" => 20, "title" => "Confirm the new password.") );
    }

    $html .= $ef->DataEntryLine( "Full Name", "%s", "text", "fullname",
              array( "size" => 50, "title" => "The description of the system.") );

    $html .= $ef->DataEntryLine( "Email", "%s", "text", "email",
              array( "size" => 50, "title" => "The user's e-mail address.") );

    // Organisation drop-down
    if ( $session->AllowedTo("Admin") || $session->AllowedTo("Support") ) {

      $sql = SqlSelectOrganisations($this->org_code);
      $html .= $ef->DataEntryLine( "Organisation", "$this->org_name", "lookup", "org_code",
                array("_sql" => $sql,
                      "_null" => "--- select an organisation ---", "onchange" => "OrganisationChanged();",
                      "title" => "The organisation that this person is a part of." ) );

      $html .= $ef->DataEntryLine( "Hourly Rate", "%s", "text", "base_rate",
                array( "size" => 10, "title" => "The base hourly rate that this person is charged at.") );

    }
    else {
      if ( $this->new_record ) $this->org_name = $session->org_name;
      $html .= $ef->DataEntryLine( "Organisation", "$this->org_name", "", "" );
    }

    $html .= $ef->DataEntryLine( "Location", "%s", "text", "location",
              array( "size" => 50, "title" => "The user's normal location within their organisation.") );

    $html .= $ef->DataEntryLine( "Phone", "%s", "text", "phone",
              array( "size" => 20, "title" => "The user's normal phone number during business hours.") );

    $html .= $ef->DataEntryLine( "Mobile", "%s", "text", "mobile",
              array( "size" => 20, "title" => "The user's mobile phone number.") );

    $this->active = ( $this->status != 'I' ? "t" : "f");
    $html .= $ef->DataEntryLine( "Active?", ($this->status != 'I' ? "Active" : "Inactive"), "checkbox", "active",
              array("_label" => "Uncheck to make the user inactive.") );

    $html .= $ef->DataEntryLine( "Send Email?", ($this->email_ok == 't' ? "Yes" : "No"), "checkbox", "email_ok",
              array("_label" => "Uncheck to ensure the user gets no e-mail.") );

    return $html;
  }

  function RenderFontChoices( $ef ) {
    global $session;
    $html = "";

    $html .= '<tr><th class="prompt">Font Size</th><td class="entry">';

    if ( $ef->editmode ) {
      for( $i=7; $i < 22; $i += 2 ) {
        $html .= $ef->DataEntryField( "", "radio", "base_font_size",
              array("title"  => "Choose the base size for fonts to be displayed for you.",
                    "value"  => "$i",
                    "_label" => sprintf('%spt.',$i)) );
      }
    }
    else {
      $html .= sprintf( "%d pt.", $this->base_font_size);
    }
    $html .= '</td></tr>'."\n";

    $html .= '<tr><th class="prompt">Entry Boxes</th><td class="entry">';
    if ( $ef->editmode ) {
      $html .= " Rows: ";
      $html .= $ef->DataEntryField( "", "text", "box_rows",
              array("title"  => "Choose the number of rows for default text entry.",
                    "size"   => 4) );
      $html .= " &nbsp; Columns: ";
      $html .= $ef->DataEntryField( "", "text", "box_cols",
              array("title"  => "Choose the number of rows for default text entry.",
                    "size"   => 4) );
    }
    else {
      $html .= sprintf( "%d rows x %d columns", $this->box_rows, $this->box_cols);
    }
    $html .= '</td></tr>'."\n";

    return $html;
  }


  function RenderAccessRoles( $ef ) {
    global $session;
    $html = "";

    $sql = "SELECT * FROM ugroup LEFT JOIN group_member ";
    $sql .= "ON (ugroup.group_no = group_member.group_no AND group_member.user_no = $this->user_no) ";
    if ( ! ($session->AllowedTo('Admin') || $session->AllowedTo('Support') ) ) {
      $sql .= "WHERE EXISTS(SELECT 1 from group_member gm WHERE gm.user_no=$session->user_no AND gm.group_no=ugroup.group_no) ";
    }
    else if ( ! $session->AllowedTo('Admin') ) {
      $sql .= "WHERE ugroup.group_name != 'Admin' ";
    }
    $sql .= "ORDER BY ugroup.seq, ugroup.group_no";


    # Select the records
    $q = new PgQuery($sql, $user_no, $user_no);
    if ( $q && $q->Exec("User::RndrAccessRoles") && $q->rows ) {
      $html .= '<tr><th class="prompt">User Roles</th><td class="entry">';

      $i=0;
      while( $row = $q->Fetch() ) {
        if ( $ef->editmode ) {
          if ( $row->user_no != "" ) $this->group_member[$row->group_name] = 't';
          $html .= $ef->DataEntryField( "", "checkbox", "group_member[$row->group_name]",
                array("title" => "Is this user a member of this group?",
                      "_label" => "$row->group_name" ) );
        }
        else {
          if ( $row->user_no != "" ) {
            if ( $i++ > 0 ) $html .= ", ";
            $html .= $row->group_name;
          }
        }
      }
    }
    $html .= '</td></tr>'."\n";

    return $html;
  }


  function RenderSystemRoles( $ef ) {
    global $session;
    $html = "";

    $sql = "SELECT lookup_code, lookup_desc FROM lookup_code ";
    $sql .= "WHERE source_table = 'system_usr' AND source_field = 'role' ORDER BY lookup_seq;";
    $q = new PgQuery($sql);
    if ( $q && $q->Exec("User::RenderSystemRoles1") && $q->rows ) {
      if ( $this->AllowedTo('Admin') || $this->AllowedTo('Support') )
        $roles = array();  // There is no 'No Access' option for such people...
      else
        $roles = array('_' => '-- No Access --');
      while( $row = $q->Fetch() ) {
        $display_roles["_$row->lookup_code"] = $row->lookup_desc;
        if ( $this->AllowedTo('Admin') || $this->AllowedTo('Support')  || $this->AllowedTo('Contractor') ) {
          if ( $row->lookup_code == 'A' || $row->lookup_code == 'S' || $row->lookup_code == 'E' )
            $roles["_$row->lookup_code"] = $row->lookup_desc;
        }
        else {
          if ( ! ($row->lookup_code == 'A' || $row->lookup_code == 'S') )
            $roles["_$row->lookup_code"] = $row->lookup_desc;
        }
      }
    }

    if ( intval("$this->user_no") == 0 ) return;
    $sql = "SELECT work_system.*, system_usr.role ";
    $sql .= "FROM work_system LEFT JOIN system_usr ";
    $sql .= "ON (work_system.system_id = system_usr.system_id AND system_usr.user_no = $this->user_no) ";
    $sql .= "WHERE work_system.active ";
    if ( ($session->AllowedTo('Admin') || $session->AllowedTo('Support'))
                      && ($this->AllowedTo('Admin') || $this->AllowedTo('Support')) ) {
      // Actually, we do nothing in this case...
      $session->Dbg("User", "Admin/Support maintains Admin/Support person.  Almost all systems shown");
      $sql .= "AND (NOT organisation_specific OR EXISTS( SELECT 1 from org_system WHERE org_system.org_code = $this->org_code AND org_system.system_id = work_system.system_id)) ";
    }
    elseif ( $session->AllowedTo('Admin') || $session->AllowedTo('Support') ) {
      $sql .= "AND EXISTS( SELECT 1 from org_system WHERE org_system.org_code = $this->org_code AND org_system.system_id = work_system.system_id) ";
      $session->Dbg("User", "Admin/Support maintains non Admin/Support person.  Org related systems only shown");
    }
    elseif ( $session->AllowedTo('OrgMgr') ) {
      $sql .= "AND EXISTS( SELECT 1 from org_system WHERE org_system.org_code = $session->org_code AND org_system.system_id = work_system.system_id) ";
      $session->Dbg("User", "OrgMgr maintains person.  Maintainer org related systems only shown");
    }
    else {
      $sql .= "AND system_usr.user_no = $session->user_no ";
      $session->Dbg("User", "non Admin/Support/OrgMgr maintains person.  Only assigned systems shown");
    }
    $sql .= "ORDER BY lower(work_system.system_desc)";


    # Select the records
    $q = new PgQuery($sql);
    $column = 0;
    if ( $q && $q->Exec("User::RenderSystemRoles2") && $q->rows ) {
      $html .= $ef->BreakLine("Active System Roles");
      $html .= '<tr><th class="prompt">&nbsp;</th><td class="entry"><table width="100%">'."\n";

      if ( $ef->editmode  && ($session->AllowedTo('Admin') || $session->AllowedTo('Support') || $session->AllowedTo('OrgMgr')) ) {
        $html .= '<tr class="row1">';
        $html .= <<<SCRIPT
<th class="prompt" style="width:auto;">
<script language="javascript">
//////////////////////////////////////////////////////////
// Since PHP wants a field returning multiple values to
// be named like "variable[]"
//////////////////////////////////////////////////////////
function ApplyToRoles(to_all) {
  for ( var i=0; i < document.forms.form.elements.length ; i++ ) {
    if ( document.forms.form.elements[i].name.match( /^role/ ) ) {
      if ( to_all || document.forms.form.elements[i].value == '' ) {
        document.forms.form.elements[i].value = document.forms.form.default_role.value;
      }
    }
  }
  return true;
}
</script>
SCRIPT;
        $ef->TempLineFormat('<span class="srchf" style="white-space: nowrap">%s%s</span>' );
        $btn_all = $ef->DataEntryLine( "", "", "button", "apply_all",
                    array("value" => "All",
                          "onclick" => "ApplyToRoles(true);",
                          "title" => "Click to apply the default to all systems for this user.",
                          "class" => "fsubmit" ) );
        $btn_some = $ef->DataEntryLine( "", "", "button", "apply_new",
                    array("value" => "Unassigned",
                          "onclick" => "ApplyToRoles(false);",
                          "title" => "Click to apply the default to unassigned systems for this user.",
                          "class" => "fsubmit" ) );
        $ef->RevertLineFormat( );

        $html .= "Choose a default and apply to $btn_all or $btn_some systems</th>";

        $html .= '<td class="entry">';
        $options = array_merge($roles, array("title" => "Select the role this person has in relation to this system"));
        $this->role[$row->system_id] = $row->role;
        $html .= $ef->DataEntryField( "", "select", "default_role", $options );
        $html .= "</td></tr>";
      }

      while( $row = $q->Fetch() ) {
        $html .= sprintf( '<tr class="row%d">', $q->rownum % 2);
        if ( trim($row->system_desc) == "" ) $row->system_desc = "&lt;&lt;&lt;unknown&gt;&gt;&gt;";
        $html .= '<td class="entry">';
        $html .= "<a href=\"/system.php?system_id=$row->system_id\">$row->system_desc</a>";
        $html .= "</td>";
        $html .= '<td class="entry">';
        if ( $ef->editmode  && ($session->AllowedTo('Admin') || $session->AllowedTo('Support') ||
             ($session->AllowedTo('OrgMgr') && !($row->role == 'A' || $row->role == 'S') ) ) ) {
          $options = array_merge($roles, array("title" => "Select the role this person has in relation to this system"));
          $html .= sprintf("<span style=\"color: %s; white-space: normal;\">", ( "$row->role" == "" ? "black" : "red") );
          $this->role[$row->system_id] = $row->role;
          $html .= $ef->DataEntryField( "", "select", "role[$row->system_id]", $options );
          $html .= "</span>";
        }
        else {
          $html .= $row->role . " - " . $display_roles["_$row->role"];
        }
        $html .= "</td></tr>";
      }
    }
    $html .= '</table></td></tr>'."\n";

    return $html;
  }


  function Validate( $ef ) {
    global $session, $client_messages;
    $session->Dbg("User", "User::Validate: Validating user");

    if ( isset($_POST) ) {
      $valid = true;
      $_POST['status'] = ( isset($_POST['active']) && ($_POST['active'] != 'off') ? 'A' : 'I' );

      if ( trim($_POST['fullname']) == "" ) {
        $client_messages[] = "ERROR: The full name may not be blank.";
        $valid = false;
      }

      if ( !($session->AllowedTo("Admin") || $session->AllowedTo("Support") ) ) {
        if ( $this->user_no == 0 )
          $_POST['org_code'] = $session->org_code;
        else
          unset($_POST['org_code']);
      }
      if ( isset($_POST['org_code']) && intval($_POST['org_code']) == 0 ) {
        $client_messages[] = "ERROR: The organisation must be selected.";
        $valid = false;
      }

      return $valid;
    }

    $client_messages[] = "ERROR: No form data submitted!";
    return false;
  }


  function Write( $ef ) {
    global $session, $client_messages;

    $session->Dbg("User", "Writing usr form details to database");

    $this->chtype = strtolower($_POST['submit']);
    if ( ! $this->AllowedTo($this->chtype) ) {
      $client_messages[] = "ERROR: You do not have privileges to $this->chtype - please contact the administrator.";
      return;
    }

    $client_messages[] = "Writing user details to database.";

    $db_errors = false;
    $qry = new PgQuery("BEGIN");   $qry->Exec("User::Write");

    if ( !is_object($this->settings)) $this->settings = new Setting;
    $this->settings->set('fontsize', $_POST['base_font_size']);
    $this->settings->set('bigboxrows', $_POST['box_rows']);
    $this->settings->set('bigboxcols', $_POST['box_cols']);
    if ( is_object( $this->settings ) ) $_POST['config_data'] = $this->settings->to_save();

    unset($_POST['password']);  // Just in case...
    if ( $this->AllowedTo('ChangePassword') ) {
      if ( $_POST['new_password'] != '******' && $_POST['new_password'] == $_POST['confirm_password'] ) {
        $newpw = session_salted_md5($_POST['new_password']);
        $_POST['password'] = $newpw;
        $session->Dbg("User", "New salted password = $newpw");
      }
      else if ( $_POST['new_password'] != '******' && $_POST['new_password'] != $_POST['confirm_password'] ) {
        $client_messages[] = "WARNING: Confirmation password does not match - the password was not changed.";
      }
    }

    if ( isset($_POST['base_rate']) ) $_POST['base_rate'] = doubleval($_POST['base_rate']);

    $sql = sql_from_post( $this->chtype, "usr", "WHERE user_no='$this->user_no'");
    $qry = new PgQuery($sql);
    if ( !$qry->Exec("User::Write") ) {
      if ( preg_match( '/duplicate key/i', $qry->errorstring ) )
        $client_messages[] = "ERROR: That User Name is already in use";
      else
        $client_messages[] = "ERROR: $qry->errorstring";
      $db_errors = true;
    }
    else {
      // If we are creating a new record, we need to grab the ID that it got
      if ( "create" == $this->chtype ) {
        // Fetch the user_no for this record.
        $sql = "SELECT currval('usr_user_no_seq');";
        $qry = new PgQuery($sql);
        $qry->Exec("User::Write");
        $row = $qry->Fetch(true);    // Fetch results as array
        $GLOBALS['user_no'] = $row[0];
        $GLOBALS['edit'] = 1;    // Assume we want further editing

        // Fetch the other details for the request and assign them into this object.
        $this->ReadUser($GLOBALS['user_no']);
      }
    }

    if ( isset($_POST['group_member']) && is_array($_POST['group_member']) ) {
      $groups = "";
      foreach( $_POST['group_member'] AS $k => $v ) {
        if ( $v && $v != "off" ) {
          $groups .= ( "$groups" == "" ? "" : ", " );
          $groups .= qpg($k);
        }
      }
      if ( $groups == "" )
        $sql = "DELETE FROM group_member WHERE user_no = '$this->user_no';";
      else {
        $sql = "DELETE FROM group_member WHERE user_no = '$this->user_no' ";
        $sql .= "AND group_no NOT IN ( SELECT group_no FROM ugroup WHERE group_name IN ($groups) );";
        $sql .= "INSERT INTO group_member ( group_no, user_no) ";
        $sql .=   "SELECT group_no, $this->user_no FROM ugroup WHERE group_name IN ( $groups ) ";
        $sql .=     "EXCEPT SELECT group_no, user_no FROM group_member;";
      }
      // echo "<p>$sql</p>";
      $qry = new PgQuery($sql);
      if ( !$qry->Exec("Sys::Write") ) $client_messages[] = "ERROR: $qry->errorstring";
    }

    if ( isset($_POST['role']) && is_array($_POST['role']) ) {
      $systems = "";
      $role_update = "";
      while( list($k,$v) = each($_POST['role']) ) {
        if ( $v ) {
          $systems .= ( "$systems" == "" ? "" : ", " );
          $systems .= "'" . str_replace("'","''",str_replace('\\','', $k)) . "'";
          $role_update .= "SELECT set_system_role($this->user_no,'" . str_replace("'","''",str_replace('\\','', $k))
                          . "','" . str_replace("'","''",str_replace('\\','', $v)) . "');";
        }
      }
      if ( $systems == "" )
        $sql = "DELETE FROM system_usr WHERE user_no = '$this->user_no';";
      else {
        $sql = "DELETE FROM system_usr WHERE user_no = '$this->user_no' AND system_id NOT IN ( $systems ) ";
        if ( ! ($session->AllowedTo('Admin') || $session->AllowedTo('Support')) ) {
          $sql .= "AND role NOT IN ( 'A', 'S' ) ";
        }
        $sql .= ";" . $role_update;
      }
      $qry = new PgQuery($sql);
      if ( !$qry->Exec("Sys::Write") ) $client_messages[] = "ERROR: $qry->errorstring";
    }

    $qry = new PgQuery("COMMIT;");  $qry->Exec("Sys::Write");

    return true;
  }

}
?>

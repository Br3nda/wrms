<?php
/////////////////////////////////////////////////////////////
//   C L A S S   F O R   W O R K   R E Q U E S T S
/////////////////////////////////////////////////////////////
require_once("html-format.php");
require_once("guess-file-type.php");
class Request {
   var $request_id;      // Which WR is this
   var $new_record;

   function Request( $id = 0 ) {
     global $session;
     if ( !$session->logged_in ) return false;
     $loaded = false;
     $id = intval("$id");
     if ( $id > 0 ) {
       // Try and load it from file
       // Note: careful adjustment of the field order - work_system and request both have 'active' e.g.
       $sql = "SELECT organisation.*, usr.*, work_system.*, request.*";
       $sql .= ", to_char( request.requested_by_date, 'dd/mm/yyyy' ) AS requested_by_date, to_char( request.agreed_due_date, 'dd/mm/yyyy' ) AS agreed_due_date ";
       $sql .= ", status.lookup_desc AS status_desc";
       $sql .= ", request_type.lookup_desc AS request_type_desc";
       $sql .= ", urgency.lookup_desc AS urgency_desc";
       $sql .= ", sla_response.lookup_desc AS sla_response_desc";
       $sql .= ", importance.lookup_desc AS importance_desc";
       $sql .= ", system_desc, request_sla_code(sla_response_time,sla_response_type) ";
       $sql .= " FROM request LEFT OUTER JOIN usr ON (request.requester_id = usr.user_no)";
       $sql .= " LEFT OUTER JOIN organisation USING( org_code )";
       $sql .= " LEFT OUTER JOIN lookup_code AS status ON status.source_table='request' AND status.source_field='status_code' AND status.lookup_code = request.last_status";
       $sql .= " LEFT OUTER JOIN lookup_code AS request_type ON request_type.source_table='request' AND request_type.source_field='request_type' AND request.request_type = request_type.lookup_code";
       $sql .= " LEFT OUTER JOIN lookup_code AS urgency ON urgency.source_table='request' AND urgency.source_field='urgency' AND int4(urgency.lookup_code)=request.urgency";
       $sql .= " LEFT OUTER JOIN lookup_code AS sla_response ON sla_response.source_table='request' AND sla_response.source_field='sla_response' AND sla_response.lookup_code=request_sla_code(sla_response_time,sla_response_type)";
       $sql .= " LEFT OUTER JOIN lookup_code AS importance ON importance.source_table='request' AND importance.source_field='importance' AND int4(importance.lookup_code)=request.importance";
       $sql .= " LEFT OUTER JOIN work_system USING( system_code )";
       $sql .= " WHERE request.request_id = '$id'";
       if ( !($session->AllowedTo('Admin') || $session->AllowedTo('Support')) )
         $sql .= " AND organisation.org_code = '$session->org_code' ";

       if ( $qry = new PgQuery($sql) ) {
         if ( $qry->Exec("newRequest")
                  && $qry->rows == 1 && $row = $qry->Fetch() ) {
           $this->new_record = false;
           while( list($k,$v) = each($row) ) {
             if ( isset($debuggroups['Request']) && $debuggroups['Request'] ) {
               error_log( sprintf("%s: DBG: \$this->{'%-25.25s = %s", $sysabbr, "$k'}", $v) );
             }
             $this->{$k} = $v;
           }
         }
       }
     }
     else {
       $this->new_record = true;
       $this->request_id = 0;
       // Assign some defaults because it looks like we're starting a new one
       if ( isset($_GET['wr_template']) ) {
         // Oh goody, we can get some defaults from a saved template :-)
         $loaded = false;  // templates aren't done yet :-(
       }
       if ( ! $loaded ) {
         // Initialise to standard default values
       }
     }
   }

   /////////////////////////////////////////////////////////////
   // AllowedTo - Can the user do that to this request?
   /////////////////////////////////////////////////////////////
   function AllowedTo( $action ) {
     return true;  // Of course they can!
   }

   /////////////////////////////////////////////////////////////
   // Render - Return HTML to show the W/R
   //   A separate function is called for each logical area
   //   on the W/R.
   /////////////////////////////////////////////////////////////
   function Render( ) {
     global $edit;
     $html = "";

     $ef = new EntryForm( $REQUEST_URI, $this, $edit );
     $ef->NoHelp();  // Prefer this style, for the moment

     if ( $edit ) $html .= $ef->StartForm( array("autocomplete" => "off", "onsubmit" => "return CheckRequestForm();" ) );

     $html .= "<table width=\"100%\" class=\"data\" cellspacing=\"0\" cellpadding=\"0\">\n";

     $html .= $this->RenderDetails($ef);
     $html .= $this->RenderAttachments($ef);
     $html .= $this->RenderQuotations($ef);
     $html .= $this->RenderRelations($ef);
     $html .= $this->RenderAllocations($ef);
     $html .= $this->RenderTimesheets($ef);
     $html .= $this->RenderInterests($ef);
     $html .= $this->RenderNotes($ef);
     $html .= $this->RenderStatuses($ef);

     if ( $edit ) $html .= $ef->SubmitButton( "submit", ($this->new_record ? "Create" : "Update") );
     $html .= "</table>\n";
     if ( $edit ) $html .= $ef->EndForm();

     return $html;
   }


   /////////////////////////////////////////////////////////////
   /////////////////////////////////////////////////////////////
   function RenderDetails( $ef ) {
     global $edit, $session, $bigboxcols, $bigboxrows;
     $html = "";
     $html .= $ef->BreakLine("Request Details");
     if ( !$this->new_record ) {
       $html .= $ef->DataEntryLine( "W/R #", "$this->request_id &nbsp; &nbsp; <b>Requested:</b> " . nice_date($this->request_on));
     }

     $html .= $ef->DataEntryLine( "Brief", "%s", "text", "brief",
               array( "size" => 70, "title" => "A brief description of the request.") );

     // Organisation drop-down
     if ( $session->AllowedTo("Admin") || $session->AllowedTo("Support") ) {
       $sql = "SELECT org_code, org_name || ' (' || abbreviation || ')' AS org_name ";
       $sql .= "FROM organisation WHERE active AND abbreviation !~ '^ *$' ";
       $sql .= "AND EXISTS(SELECT user_no FROM usr WHERE usr.org_code = organisation.org_code AND usr.status != 'I') ";
       $sql .= "AND EXISTS(SELECT work_system.system_code FROM org_system JOIN work_system ON (org_system.system_code = work_system.system_code) WHERE org_system.org_code = organisation.org_code AND work_system.active) ";
       $sql .= "ORDER BY lower(org_name)";
       $html .= $ef->DataEntryLine( "Organisation", "$this->org_name", "lookup", "org_code",
                 array("_sql" => $sql, "_null" => "--- select an organisation ---", "onchange" => "OrganisationChanged();" ) );
     }
     else {
       $html .= $ef->DataEntryLine( "Organisation", "$this->org_name", "", "" );
     }

     // Person within Organisation drop-down
     $sql = "SELECT user_no, fullname ";
     if ( $this->new_record ) $sql .= " ||' ('||abbreviation||')' ";
     $sql .= "FROM usr JOIN organisation ON organisation.org_code = usr.org_code ";
     if ( $this->new_record ) {
       $sql .= "WHERE status != 'I' AND organisation.active ";
       if ( ! ($session->AllowedTo("Admin") || $session->AllowedTo("Support") ) )
         $sql .= "AND organisation.org_code = $session->org_code AND usr.org_code = $session->org_code ";
       $sql .= "AND EXISTS(SELECT work_system.system_code FROM org_system JOIN work_system ON (org_system.system_code = work_system.system_code) WHERE org_system.org_code = organisation.org_code AND work_system.active) ";
     }
     else {
       $sql .= "WHERE organisation.org_code = $this->org_code AND usr.org_code = $this->org_code ";
     }
     $sql .= "ORDER BY lower(fullname)";
     $html .= $ef->DataEntryLine( "Person", "$this->fullname", "lookup", "requester_id",
               array("_sql" => $sql, "_null" => "--- select a person ---", "onchange" => "PersonChanged();" ) );

     // System (within Organisation) drop-down
     $sql = "SELECT work_system.system_code, system_desc FROM work_system ";
     if ( $this->new_record ) {
       if ( ! ($session->AllowedTo("Admin") || $session->AllowedTo("Support") ) )
         $sql .= "JOIN org_system ON org_system.system_code = work_system.system_code ";
       $sql .= "WHERE active ";
       if ( ! ($session->AllowedTo("Admin") || $session->AllowedTo("Support") ) )
         $sql .= "AND org_system.org_code = $session->org_code ";
     }
     else {
       $sql .= "JOIN org_system ON org_system.system_code = work_system.system_code ";
       $sql .= "WHERE org_system.org_code = $this->org_code ";
     }
     $sql .= "ORDER BY lower(system_desc)";
     $html .= $ef->DataEntryLine( "System", "$this->system_desc", "lookup", "system_code",
               array("_sql" => $sql, "_null" => "--- select a system ---", "onchange" => "SystemChanged();") );

     // Type of Request
     $html .= $ef->DataEntryLine( "Type", $this->request_type_desc, "lookup", "request_type",
               array("_type" => "request|request_type") );

     // Urgency of Request
     $html .= $ef->DataEntryLine( "Urgency", $this->urgency_desc, "lookup", "urgency",
               array("_type" => "request|urgency") );

     // Importance of Request
     $html .= $ef->DataEntryLine( "Importance", $this->importance_desc, "lookup", "importance",
               array("_type" => "request|importance") );

     // Detailed description
     $html .= $ef->DataEntryLine( "Details", html_format($this->detailed), "textarea", "detailed",
               array("title" => "Full details of the request", "rows" => $bigboxrows, "cols" => $bigboxcols  ) );

     return $html;
   }


   /////////////////////////////////////////////////////////////
   /////////////////////////////////////////////////////////////
   function RenderAttachments( $ef ) {
     global $session;
     $html = "";
     $sql = "SELECT att_filename, attachment_id, att_brief, att_description, ";
     $sql .= "to_char(attached_on, 'HH24:MI DD-MM-YYYY') AS att_on, fullname, type_desc ";
     $sql .= "FROM request_attachment JOIN usr ON ( attached_by = user_no ) ";
     $sql .= "LEFT OUTER JOIN attachment_type ON ( request_attachment.att_type = attachment_type.type_code ) ";
     $sql .= "WHERE request_id = $this->request_id ";
     $sql .= "ORDER BY request_id, attachment_id";
     # Select the records
     $q = new PgQuery($sql);
     $q->Exec('WR::Attachments') ;
     if ( $ef->editmode || $q->rows )
       $html .= $ef->BreakLine("Attached Files");
     if ( $q->rows ) {
       $html .= '<tr><td colspan="2"><table width="100%">'."\n";
       $html .= '<tr><th class="pcol">File</th><th class="pcol">Description</th><th class="pcol">By</th><th class="pcol">On</th><th class="pcol">Type</th></tr>'."\n";
       $attachment_format = '<tr class="row%d"><td class="entry"><a href="/attachment.php/%s?id=%d">%s</a></td>';
       $attachment_format .= '<td class="entry">%s</td><td class="entry" style="white-space: nowrap;">%s</td><td class="entry">%s</td><td class="entry">%s</td></tr>'."\n";
       while( $row = $q->Fetch() ) {
         $html .= sprintf( $attachment_format, ($q->rownum % 2),
                    $row->att_filename, $row->attachment_id, $row->att_filename, $row->att_brief,
                    $row->fullname, $row->att_on, $row->type_desc
                  );
       }
       $html .= '</table></td></tr>'."\n";
     }

     if ( $ef->editmode ) {
       $html .= '<tr><td colspan="2"><table><tr>'."\n";
       // Select the file
       $html .= '<th class="prompt">Add File</th><td class="entry">';
       $html .= $ef->DataEntryField( "", "file", "att_filename",
                 array("title" => "Enter the name of the file to be attached" ) );
       $html .= '</td>';

       // Enter the description
       $html .= '<th class="prompt">Description</th><td class="entry">';
       $html .= $ef->DataEntryField( "", "text", "att_brief",
                 array("title" => "Enter a description for the file", "size" => 50 ) );
       $html .= '</td>';

       $html .= '</tr></table></td></tr>'."\n";
     }
     return $html;
   }


   /////////////////////////////////////////////////////////////
   /////////////////////////////////////////////////////////////
   function RenderQuotations( $ef ) {
     global $session;
     $html = "";
     $sql = "SELECT request_quote.*, ru.fullname AS quote_by, au.fullname AS approved_by, ";
     $sql .= "to_char(quoted_on, 'HH24:MI DD-MM-YYYY') AS quoted_on, lookup_desc AS quote_type_desc ";
     $sql .= "FROM request_quote ";
     $sql .= "LEFT OUTER JOIN usr ru ON ( request_quote.quote_by_id = ru.user_no ) ";
     $sql .= "LEFT OUTER JOIN usr au ON ( request_quote.approved_by_id = au.user_no ) ";
     $sql .= "LEFT OUTER JOIN lookup_code ON ( source_table = 'request_quote' AND source_field = 'quote_type' AND lookup_code = request_quote.quote_type) ";
     $sql .= "WHERE request_id = $this->request_id ";
     $sql .= "ORDER BY request_id, quote_id";
     # Select the records
     $q = new PgQuery($sql);
     $q->Exec('WR::Quotations');
     if ( $ef->editmode || $q->rows )
       $html .= $ef->BreakLine("Quotations");
     if ( $q->rows ) {
       $html .= '<tr><td colspan="2"><table width="100%">'."\n";
       $html .= '<tr><th class="pcol">Type</th>';
       $html .= '<th class="pcol">Quote On</th>';
       $html .= '<th class="pcol">By</th>';
       $html .= '<th class="pcol">Brief</th>';
       $html .= '<th class="pcol">Quote</th></tr>'."\n";
       $line_format = '<tr class="row%d"><td class="entry" width="5%%">%s</td>';
       $line_format .= '<td class="entry">%s</td>';
       $line_format .= '<td class="entry" style="white-space: nowrap;">%s</td>';
       $line_format .= '<td class="entry">%s</td>';
       $line_format .= '<td class="entry" style="white-space: nowrap;">%s %s</td></tr>'."\n";
       $detail_format = '<tr class="row%d"><td class="entry">&nbsp;</td><td class="entry" colspan="4">%s</td></tr>'."\n";
       while( $row = $q->Fetch() ) {
         $html .= sprintf( $line_format,
                    ($q->rownum % 2), $row->quote_type_desc, $row->quote_by, $row->quoted_on, $row->quote_brief,
                    $row->quote_amount, $row->quote_units
                  );
         if ( trim("$row->quote_details") != "" ) {
           $html .= sprintf( $detail_format,
                    ($q->rownum % 2), $row->quote_details
                  );
         }
       }
       $html .= '</table></td></tr>'."\n";
     }

     if ( $ef->editmode ) {
       $html .= '<tr><td colspan="2"><table><tr>'."\n";

       $html .= '<th class="prompt">Add Quote</th><td class="entry">';
       $html .= $ef->DataEntryField( "", "text", "quote_brief",
                 array("title" => "Enter brief description of the quote", "size" => 40 ) );
       $html .= '</td>';

       $html .= '<th class="prompt">Type</th><td class="entry">';
       $html .= $ef->DataEntryField( "", "lookup", "quote_type",
                 array("_type" => "request_quote|quote_type", "style" => "width: 6em;",
                       "title" => "The type of quote you are entering" ) );
       $html .= '</td>';

       $html .= '<th class="prompt">Amount</th><td class="entry">';
       $html .= $ef->DataEntryField( "", "number", "quote_amount",
                 array("title" => "Enter the amount of the quote",
                       "size" => 10, "onblur" => "this.value=CheckNumber(this,0,999999999)" ) );
       $html .= '</td>';

       $html .= '<td class="entry">';
       $html .= $ef->DataEntryField( "", "lookup", "quote_units",
                 array("_type" => "request_quote|quote_units", "style" => "width: 6em;",
                       "title" => "The units for the amount of the quote you are adding" ) );
       $html .= '</td>';

       $html .= '</tr>';

       // Enter the description
       $html .= '<tr><th class="prompt">Description</th><td class="entry" colspan="5">';
       $html .= $ef->DataEntryField( "", "textarea", "quote_details",
                 array("title" => "Enter a detailed description for the quote.", "cols" => 70, "rows" => 4 ) );
       $html .= '</td>';

       $html .= '</tr></table></td></tr>'."\n";
     }
     return $html;
   }


   /////////////////////////////////////////////////////////////
   /////////////////////////////////////////////////////////////
   function RenderRelations( $ef ) {
     global $session;
     $html = "";
     $header_done = false;
     $sql = "SELECT parent.*, request_request.*, parent.request_id AS parent_id, ";
     $sql .= "lsd.lookup_desc AS last_status_desc, llt.lookup_desc AS link_type_desc ";
     $sql .= "FROM request_request ";
     $sql .= "JOIN request parent ON (request_request.request_id = parent.request_id) ";
     $sql .= "JOIN request child ON (request_request.to_request_id = child.request_id) ";
     $sql .= "JOIN lookup_code lsd ON (lsd.source_table = 'request' AND lsd.source_field = 'status_code' AND lsd.lookup_code = parent.last_status) ";
     $sql .= "JOIN lookup_code llt ON (llt.source_table = 'request_request' AND llt.source_field = 'link_type' AND llt.lookup_code = request_request.link_type) ";
     $sql .= "WHERE request_request.to_request_id = ? ";
     $sql .= "ORDER BY request_request.request_id, request_request.to_request_id ";
     # Select the records
     $q = new PgQuery($sql, $this->request_id);
     $q->Exec('WR::Relations');
     if ( $ef->editmode || $q->rows ) {
       $html .= $ef->BreakLine("Related Requests");
       $header_done = true;
     }
     if ( $q->rows ) {
       $html .= '<tr><td colspan="2"><table width="100%">'."\n";
       $html .= '<tr><th class="pcol">Parent</th>';
       $html .= '<th class="pcol">Brief</th>';
       $html .= '<th class="pcol">Status</th>';
       $html .= '<th class="pcol">Link</th>';
       $html .= '<th class="pcol">This W/R</th></tr>'."\n";
       $line_format = '<tr class="row%d"><td class="entry" width="5%%"><a href="/wr.php?request_id=%d">%s</a></td>';
       $line_format .= '<td class="entry"><a href="/wr.php?request_id=%d">%s</a></td>';
       $line_format .= '<td class="entry">%s</td>';
       $line_format .= '<td class="entry">%s</td>';
       $line_format .= '<td class="entry">%s</td></tr>'."\n";
       while( $row = $q->Fetch() ) {
         if ( trim($row->brief) == '' ) $row->brief = substr($row->detailed,0,50) . "...";
         $html .= sprintf( $line_format,
                    ($q->rownum % 2), $row->parent_id, $row->parent_id, $row->parent_id, $row->brief, $row->last_status_desc, $row->link_type_desc,
                    $this->request_id
                  );
       }
       $html .= '</table></td></tr>'."\n";
     }

     $sql = "SELECT child.*, request_request.*, child.request_id AS child_id, ";
     $sql .= "lsd.lookup_desc AS last_status_desc, llt.lookup_desc AS link_type_desc ";
     $sql .= "FROM request_request ";
     $sql .= "JOIN request parent ON (request_request.request_id = parent.request_id) ";
     $sql .= "JOIN request child ON (request_request.to_request_id = child.request_id) ";
     $sql .= "JOIN lookup_code lsd ON (lsd.source_table = 'request' AND lsd.source_field = 'status_code' AND lsd.lookup_code = parent.last_status) ";
     $sql .= "JOIN lookup_code llt ON (llt.source_table = 'request_request' AND llt.source_field = 'link_type' AND llt.lookup_code = request_request.link_type) ";
     $sql .= "WHERE request_request.request_id = ? ";
     $sql .= "ORDER BY request_request.request_id, request_request.to_request_id ";
     # Select the records
     $q = new PgQuery($sql, $this->request_id);
     $q->Exec('WR::Relations');
     if ( ! $header_done && ($ef->editmode || $q->rows) ) {
       $html .= $ef->BreakLine("Related Requests");
       $header_done = true;
     }
     if ( $q->rows ) {
       $html .= '<tr><td colspan="2"><table width="100%">'."\n";
       $html .= '<tr><th class="pcol" style="white-space: nowrap;">This W/R</th>';
       $html .= '<th class="pcol">Link</th>';
       $html .= '<th class="pcol">Child</th>';
       $html .= '<th class="pcol">Brief</th>';
       $html .= '<th class="pcol">Status</th></tr>'."\n";
       $line_format = '<tr class="row%d"><td class="entry" width="5%%">%s</td>';
       $line_format .= '<td class="entry">%s</td>';
       $line_format .= '<td class="entry"><a href="/wr.php?request_id=%d">%s</a></td>';
       $line_format .= '<td class="entry"><a href="/wr.php?request_id=%d">%s</a></td>';
       $line_format .= '<td class="entry">%s</td></tr>'."\n";
       while( $row = $q->Fetch() ) {
         if ( trim($row->brief) == '' ) $row->brief = substr($row->detailed,0,50) . "...";
         $html .= sprintf( $line_format,
                    ($q->rownum % 2), $this->request_id, $row->link_type_desc,
                    $row->child_id, $row->child_id, $row->child_id, $row->brief, $row->last_status_desc
                  );
       }
       $html .= '</table></td></tr>'."\n";
     }

     if ( $ef->editmode ) {
       $html .= '<tr><td colspan="2"><table><tr>'."\n";

       $html .= '<th class="prompt">From W/R</th><td class="entry">';
       $html .= $ef->DataEntryField( "", "integer", "parent_request_id",
                 array("title" => "Enter the W/R# of the parent request", "size" => 8,
                       "onblur" => "this.value=CheckNumber(this,0,99999999)" ) );
       $html .= '</td>';

       $html .= '<th class="prompt">Link Type</th><td class="entry">';
       $html .= $ef->DataEntryField( "", "lookup", "link_type",
                 array("_type" => "request_request|link_type", "style" => "width: 12em;",
                       "title" => "The way the parent request links to this one" ) );
       $html .= '</td>';

       $html .= '</tr></table></td></tr>'."\n";
     }
     return $html;
   }

   /////////////////////////////////////////////////////////////
   /////////////////////////////////////////////////////////////
   function RenderAllocations( $ef ) {
     global $session;
     $html = "";
     $html .= $ef->BreakLine("Work Allocated To");
     return $html;
   }

   /////////////////////////////////////////////////////////////
   /////////////////////////////////////////////////////////////
   function RenderTimesheets( $ef ) {
     global $session;
     $html = "";
     $html .= $ef->BreakLine("Work Done");
     return $html;
   }

   /////////////////////////////////////////////////////////////
   /////////////////////////////////////////////////////////////
   function RenderInterests( $ef ) {
     global $session;
     $html = "";
     $html .= $ef->BreakLine("Interested Users");
     return $html;
   }

   /////////////////////////////////////////////////////////////
   /////////////////////////////////////////////////////////////
   function RenderNotes( $ef ) {
     global $session;
     $html = "";
     $html .= $ef->BreakLine("Notes");
     return $html;
   }

   /////////////////////////////////////////////////////////////
   /////////////////////////////////////////////////////////////
   function RenderStatuses( $ef ) {
     global $session;
     $html = "";
     $html .= $ef->BreakLine("Changes in Status");
     return $html;
   }

   /////////////////////////////////////////////////////////////
   // This is called prior to writing the record to perform any
   // cross-field (or other) validations.  If it returns false
   // then the record will not be written
   /////////////////////////////////////////////////////////////
   function Validate( $ef ) {
     global $client_messages;
     error_log("$system_name: vpw: ERROR: Not validating request");
     $client_messages[] = "WARNING: Not validating request details yet.";
     return true;
   }


   /////////////////////////////////////////////////////////////
   // This is the main routine to actually write the record.  In
   // the work request case we actually call a lot of other
   // functions (roughly corresponding to the different Render
   // ones used for displaying the form.
   /////////////////////////////////////////////////////////////
   function Write( $ef ) {
     global $client_messages;
     error_log("$system_name: vpw: Writing request details to database");
     $qry = new PgQuery("BEGIN");  $qry->Exec("WR::Write");

     $db_errors = false;
     $sql = sql_from_post( $_POST['submit'], "request", "WHERE request_id='$this->request_id'");
     $qry = new PgQuery($sql);
     if ( !$qry->Exec("WR::Write") ) {
       $client_messages[] = "$qry->errorstring";
       $db_errors = true;
     }
     else {
       // If we are creating a new record, we need to grab the ID that it got
       if ( eregi("create",$_POST['submit']) ) {
         $sql = "SELECT currval('organisation_org_code_seq';";
         $qry = new PgQuery($sql);
         $qry->Exec("WR::Write");
         $row = $qry->Fetch(true);    // Fetch results as array
         $this->request_id = $row[0];
       }
     }

     if ( !$db_errors && $_FILES['att_filename']['tmp_name'] != "" ) {
       $db_errors = ! $this->AttachFile('att_filename',$_POST['att_brief']);
     }

     if ( !$db_errors && trim($_POST['quote_brief']) != "" ) {
       $db_errors = ! $this->AddQuote();
     }

     if ( !$db_errors && intval(trim($_POST['parent_request_id'])) > 0 ) {
       $db_errors = ! $this->AddParent();
     }

     $qry = new PgQuery( ( $db_errors ? "ROLLBACK;" : "COMMIT;") );  $qry->Exec("WR::Write");
     if ( $db_errors ) {
       $client_messages[] = "ERROR: Database problem  - Request not written.";
     }
     else {
       $client_messages[] = "Request details written.";
     }
     return true;
   }

   /////////////////////////////////////////////////////////////
   /////////////////////////////////////////////////////////////
   function AttachFile( $fname, $description ) {
     global $session, $client_messages;
     error_log( "$sysabbr Request::AttachFile: DBG: Adding attachment: " . $_FILES[$fname]['name'], 0);
     $sql = "SELECT nextval('request_attachment_attachment_id_seq') AS id ;";
     $qry = new PgQuery( $sql );
     if ( ! $qry->Exec('WR::AttachFile') ) {
       $client_messages[] = "$qry->errorstring";
       return false;
     }

     $row = $qry->Fetch();
     $attachment_id = $row->id;
     move_uploaded_file($_FILES[$fname]['tmp_name'], "attachments/$attachment_id");
     $att_name = tidy($_FILES[$fname]['name']);

     $file_type = guess_file_type( $att_name, "attachments/$attachment_id" );

     $sql = "INSERT INTO request_attachment ( attachment_id, request_id, attached_by, ";
     $sql .= "att_brief, att_description, att_filename, att_type ) ";
     $sql .= "VALUES( ?, ?, ?, ?, ?, ?, ? );";
     $qry = new PgQuery( $sql, $attachment_id, $this->request_id, $session->user_no,
                       $description, $description, $att_name, $file_type);
     if ( ! $qry->Exec('WR::AttachFile') ) {
       $client_messages[] = "$qry->errorstring";
       return false;
     }

     chmod( "attachments/$attachment_id", 0644 );
     $client_messages[] = "File attachment \"$att_name\" added to this request</h3>";
     return true;
   }

   /////////////////////////////////////////////////////////////
   /////////////////////////////////////////////////////////////
   function AddQuote( ) {
     global $session, $client_messages;
     error_log( "$sysabbr Request::AddQuote: DBG: Adding quote: " . $_POST['quote_brief'], 0);
     $sql = "SELECT nextval('request_quote_quote_id_seq') AS id ;";
     $qry = new PgQuery( $sql );
     if ( ! $qry->Exec('WR::AddQuote') ) {
       $client_messages[] = "$qry->errorstring";
       return false;
     }
     $row = $qry->Fetch();
     $id = $row->id;

     $sql = "INSERT INTO request_quote ( quote_id, request_id, quote_by_id, ";
     $sql .= "quote_brief, quote_details, quote_type, quote_amount, quote_units ) ";
     $sql .= "VALUES( ?, ?, ?, ?, ?, ?, ?, ? );";
     $qry = new PgQuery( $sql, $id, $this->request_id, $session->user_no,
                         $_POST['quote_brief'], $_POST['quote_details'], $_POST['quote_type'], $_POST['quote_amount'], $_POST['quote_units'] ) ;
     if ( ! $qry->Exec('WR::AddQuote') ) {
       $client_messages[] = "$qry->errorstring";
       return false;
     }
     $client_messages[] = "Quote added to this request</h3>";
     return true;
   }

   /////////////////////////////////////////////////////////////
   /////////////////////////////////////////////////////////////
   function AddParent( ) {
     global $session, $client_messages;
     error_log( "$sysabbr Request::AddParent: DBG: Adding parent: " . $_POST['parent_request_id'], 0);

     $sql = "INSERT INTO request_request ( request_id, to_request_id, link_type, link_data ) ";
     $sql .= "VALUES( ?, ?, ?, ? );";
     $qry = new PgQuery( $sql, $_POST['parent_request_id'], $this->request_id, $_POST['link_type'], $_POST['link_data'] ) ;
     if ( ! $qry->Exec('WR::AddParent') ) {
       $client_messages[] = "$qry->errorstring";
       return false;
     }
     $client_messages[] = "W/R linked to this request</h3>";
     return true;
   }
}

?>